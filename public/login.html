<link href="/css/login.css" rel="stylesheet">
<link rel="stylesheet" href="/css/errors.css">
<div class="login-page">
  <a href="/">
    <img src="/assets/small_logo.png" />
  </a>
  <div class="error" id="error" style="display: none">
    Wrong Username/Password! Please try again!
  </div>
  <div class="form">
    <form class="login-form" onsubmit="return false">
      <input id="username" type="username" name="username" placeholder="username"/>
      <input id="password" type="password" name="password" placeholder="password"/>
      <button type="submit" id="login">login</button>
      <p class="message">Not registered? <a href="/signup">Create an account</a></p>
    </form>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="//npmcdn.com/feathers-client@2.2.0/dist/feathers.js"></script>
<script type="text/javascript">
  const socket = io();
  const client = feathers();

  client.configure(feathers.socketio(socket));
  client.configure(feathers.hooks());
  client.configure(feathers.authentication({
    storage: window.localStorage
  }));

  //try with JWT first
  client.authenticate()
  .then(response => {
    console.log('Authenticated!', response);
    window.location.href = '/profile';
    return client.passport.verifyJWT(response.accessToken);
  })
  .catch(function(error){
    console.error('Error authenticating with JWT!', error);
  });

  function getCredentials() {
    const user = {
      username: document.getElementById('username').value,
      password: document.getElementById('password').value
    };

    return user;
  }

  function login(credentials) {
    const payload = credentials ?
      Object.assign({ strategy: 'local' }, credentials) : {};

    return client.authenticate(payload)
      .then(function(result) {
          console.log('Authenticated!');
          window.location.href = '/profile';
      }).catch(function(error) {
          document.getElementById("error").style.display = 'block';
          console.error('Error authenticating!', error);
      });
  }

  document.getElementById("login").addEventListener("click", function(){
    const user = getCredentials();
    login(user);
  });
</script>